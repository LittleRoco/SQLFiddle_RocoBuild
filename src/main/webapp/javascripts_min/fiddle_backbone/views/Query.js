define(["jQuery","Underscore","Backbone","Handlebars","FiddleEditor","libs/renderTerminator","XPlans/oracle/loadswf","XPlans/mssql","text!fiddle_backbone/templates/queryTabularOutput.html","text!fiddle_backbone/templates/queryPlaintextOutput.html","text!fiddle_backbone/templates/queryMarkdownOutput.html","HandlebarsHelpers/divider_display","HandlebarsHelpers/each_simple_value_with_index","HandlebarsHelpers/each_with_index","HandlebarsHelpers/result_display_padded","HandlebarsHelpers/result_display","HandlebarsHelpers/code_format","HandlebarsHelpers/add"],function(e,t,n,r,i,s,o,u,a,f,l){var c=n.View.extend({initialize:function(){this.editor=new i(this.id,this.handleQueryChange,this,t.bind(function(){this.model.execute()},this)),this.outputType="tabular",this.compiledOutputTemplate={},this.compiledOutputTemplate.tabular=r.compile(a),this.compiledOutputTemplate.plaintext=r.compile(f),this.compiledOutputTemplate.markdown=r.compile(l)},setOutputType:function(e){this.outputType=e},handleQueryChange:function(t){var n=this.model.get("schemaDef");this.model.set({sql:this.editor.getValue()}),e(".sql .helpTip").css("display",!n.get("ready")||n.get("loading")||this.model.get("sql").length?"none":"block")},render:function(){this.editor.setValue(this.model.get("sql")),this.model.id&&this.renderOutput(),s(e(".panel.sql"),this.model.get("statement_separator"))},renderOutput:function(){var n=this.model,r=this.model.toJSON();t.each(r.sets,function(e,n){if(e.RESULTS){var i=t.map(e.RESULTS.COLUMNS,function(e){return e.length});t.each(e.RESULTS.DATA,function(e){i=t.map(e,function(e,n){return t.max([e.toString().length,i[n]])})}),r.sets[n].RESULTS.COLUMNWIDTHS=i}}),r.schemaDef=this.model.get("schemaDef").toJSON(),r.schemaDef.dbType=this.model.get("schemaDef").get("dbType").toJSON(),r.schemaDef.dbType.isSQLServer=this.model.get("schemaDef").get("dbType").get("simple_name")=="SQL Server",r.schemaDef.dbType.isPostgreSQL=this.model.get("schemaDef").get("dbType").get("simple_name")=="PostgreSQL",this.options.output_el.html(this.compiledOutputTemplate[this.outputType](r)),e("script.oracle_xplan_xml").each(function(){e(this).siblings("div.oracle_xplan").html(o(e(this).text()))}),this.options.output_el.find("a.executionPlanLink").click(function(t){t.preventDefault(),e("i",this).toggleClass("icon-minus icon-plus"),e(this).closest(".set").find(".executionPlan").toggle(),e("i",this).hasClass("icon-minus")&&n.get("schemaDef").get("dbType").get("simple_name")=="SQL Server"&&u.drawLines(e(this).closest(".set").find(".executionPlan div"))})},refresh:function(){this.editor.refresh()},checkForSelectedText:function(){this.editor.somethingSelected()?this.model.set("sql",this.editor.getSelection()):this.model.set("sql",this.editor.getValue())}});return c})