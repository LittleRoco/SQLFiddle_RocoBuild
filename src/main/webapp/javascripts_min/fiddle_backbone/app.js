define(["BrowserEngines/engines","fiddle_backbone/models/UsedFiddle","fiddle_backbone/models/MyFiddleHistory","fiddle_backbone/models/DBTypesList","fiddle_backbone/models/SchemaDef","fiddle_backbone/models/Query","fiddle_backbone/views/DBTypesList","fiddle_backbone/views/SchemaDef","fiddle_backbone/views/Query","fiddle_backbone/router","libs/renderTerminator","libs/jquery/jquery.blockUI","libs/jquery/jquery.cookie","Bootstrap/bootstrap-collapse","Bootstrap/bootstrap-tab","Bootstrap/bootstrap-dropdown","Bootstrap/bootstrap-modal","Bootstrap/bootstrap-tooltip","Bootstrap/bootstrap-popover"],function(e,t,n,r,i,s,o,u,a,f,l){var c=function(c){var h={},p=new n,d=new r,v=new i({browserEngines:e}),m=new s({schemaDef:v}),g=new o({el:$("#db_type_id")[0],collection:d}),y=new u({id:"schema_ddl",model:v,output_el:$("#output"),browser_el:$("#browser")}),b=new a({id:"sql",model:m,output_el:$("#output")});d.on("change",function(){g.render(),v.has("dbType")&&v.set("ready",v.get("short_code").length&&v.get("dbType").id==this.getSelectedType().id)}),v.on("change",function(){this.hasChanged("ready")&&y.updateDependents(),this.hasChanged("errorMessage")&&y.renderOutput(),this.hasChanged("schema_structure")&&y.renderSchemaBrowser()}),v.on("reloaded",function(){this.set("dbType",d.getSelectedType()),y.render()}),m.on("reloaded",function(){this.set({pendingChanges:!1},{silent:!0}),b.render()}),v.on("built failed",function(){$("#buildSchema label").prop("disabled",!1),$("#buildSchema label").html($("#buildSchema label").data("originalValue")),y.renderOutput(),y.renderSchemaBrowser()}),m.on("change",function(){(this.hasChanged("sql")||this.hasChanged("statement_separator"))&&!this.hasChanged("id")&&!this.get("pendingChanges")&&this.set({pendingChanges:!0},{silent:!0})}),m.on("executed",function(){var e=$(".runQuery");e.prop("disabled",!1),e.html(e.data("originalValue")),this.set({pendingChanges:!1},{silent:!0}),b.renderOutput()}),$("#buildSchema").click(function(e){var t=$("label",this);e.preventDefault();if(t.prop("disabled"))return!1;t.data("originalValue",t.html()),t.prop("disabled",!0).text("Building Schema..."),v.build()});var w=function(e){var t=$(".runQuery");e.preventDefault();if(t.prop("disabled"))return!1;t.data("originalValue",t.html()),t.prop("disabled",!0).text("Executing SQL..."),b.checkForSelectedText(),m.execute()};return $(".runQuery").click(w),$(document).keyup(function(e){e.keyCode==116&&(e.preventDefault(),w(e))}),$("#runQueryOptions li a").click(function(e){e.preventDefault(),b.setOutputType(this.id),b.renderOutput()}),$("#queryPrettify").click(function(e){var t=$(this);t.attr("disabled",!0),e.preventDefault(),$.post("index.cfm/proxy/formatSQL",{sql:m.get("sql")},function(e){m.set({sql:e}),m.trigger("reloaded"),m.set({pendingChanges:!0}),t.attr("disabled",!1)})}),$(".terminator .dropdown-menu a").on("click",function(e){e.preventDefault(),l($(this).closest(".panel"),$(this).attr("href")),$(this).closest(".panel").hasClass("schema")?y.handleSchemaChange():m.set({pendingChanges:!0,statement_separator:$(this).attr("href")},{silent:!0})}),$("#output").on("click",".depesz",function(e){var t=$(this).closest(".set").find(".executionPlan tr:not(:first)").text();$(this).closest("form").find("[name=plan]").val(t)}),$(window).bind("beforeunload",function(){if(m.get("pendingChanges"))return"Warning! You have made changes to your query which will be lost. Continue?'"}),d.on("reset",function(){h=f.initialize(d,v,m,p,g),this.length&&!this.getSelectedType()&&(this.setSelectedType(this.first().id,!0),v.set("dbType",this.getSelectedType())),g.render(),y.render(),b.render()}),p.on("change reset remove",function(){localStorage&&localStorage.setItem("fiddleHistory",JSON.stringify(this.toJSON()))}),$("#clear").click(function(e){e.preventDefault(),v.reset(),m.reset(),h.navigate("!"+d.getSelectedType().id,{trigger:!0})}),$("#sample").click(function(e){e.preventDefault(),h.navigate("!"+d.getSelectedType().get("sample_fragment"),{trigger:!0})}),d.on("change",function(){g.render(),m.id&&v.get("short_code").length&&v.get("dbType").id==this.getSelectedType().id?h.navigate("!"+this.getSelectedType().id+"/"+v.get("short_code")+"/"+m.id):v.get("short_code").length&&v.get("dbType").id==this.getSelectedType().id?h.navigate("!"+this.getSelectedType().id+"/"+v.get("short_code")):h.navigate("!"+this.getSelectedType().id),v.set("dbType",this.getSelectedType())}),v.on("built",function(){p.insert(new t({fragment:"!"+this.get("dbType").id+"/"+this.get("short_code")})),h.navigate("!"+this.get("dbType").id+"/"+this.get("short_code"))}),m.on("executed",function(){var e=this.get("schemaDef");p.insert(new t({fragment:"!"+e.get("dbType").id+"/"+e.get("short_code")+"/"+this.id})),h.navigate("!"+e.get("dbType").id+"/"+e.get("short_code")+"/"+this.id)}),d.reset(c),{dbTypes:d,schemaDef:v,schemaDefView:y,queryView:b}};return{initialize:c}})